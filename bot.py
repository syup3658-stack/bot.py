import os
import requests
import yfinance as yf
import pandas as pd
import ccxt
from datetime import datetime

# --- è¨­å®šä½ çš„ Telegram åƒæ•¸ (æ¸¬è©¦æ™‚å¯ä»¥ç›´æ¥å¡«å…¥ï¼Œè‡ªå‹•åŒ–æ™‚å»ºè­°ç”¨ç’°å¢ƒè®Šæ•¸) ---
TG_TOKEN = "ä½ çš„_TOKEN_è²¼åœ¨é€™è£¡"  # ä¾‹å¦‚ "123456:ABC..."
TG_CHAT_ID = "ä½ çš„_CHAT_ID_è²¼åœ¨é€™è£¡" # ä¾‹å¦‚ "987654321"

# å¦‚æœæ˜¯ GitHub Actions è‡ªå‹•åŒ–ï¼Œæœƒå¾ç’°å¢ƒè®Šæ•¸è®€å– (ç¨å¾Œæ•™å­¸æœƒç”¨åˆ°)
if 'TG_TOKEN' in os.environ: TG_TOKEN = os.environ['TG_TOKEN']
if 'TG_CHAT_ID' in os.environ: TG_CHAT_ID = os.environ['TG_CHAT_ID']

def get_data():
    # 1. æŠ“å–å®è§€æ•¸æ“š
    print("æ­£åœ¨æŠ“å–æ•¸æ“š...")
    tickers = ["^VIX", "^VVIX", "BTC-USD"]
    data = yf.download(tickers, period="1y", progress=False)
    
    # è™•ç† yfinance æ ¼å¼
    def get_series(ticker):
        try:
            if 'Close' in data.columns:
                df = data['Close']
                if isinstance(df, pd.DataFrame): return df[ticker]
                return df
            return data.iloc[:, 0] # Fallback
        except:
            return None

    vix = get_series("^VIX")
    vvix = get_series("^VVIX")
    btc = get_series("BTC-USD")
    
    # 2. æŠ“å–å¹£å®‰æ•¸æ“š
    binance = ccxt.binance()
    try:
        funding = binance.fapiPublic_get_premiumindex({'symbol': 'BTCUSDT'})
        fr = float(funding['lastFundingRate']) * 100
    except:
        fr = 0.0

    return vix, vvix, btc, fr

def analyze_and_send():
    vix, vvix, btc, fr = get_data()
    
    # å–æœ€æ–°å€¼
    cur_vix = float(vix.iloc[-1])
    cur_vvix = float(vvix.iloc[-1])
    cur_btc = float(btc.iloc[-1])
    
    # è¨ˆç®— Mayer Multiple
    ma200 = btc.rolling(window=200).mean().iloc[-1]
    mayer = cur_btc / ma200
    
    # --- ç”Ÿæˆå ±å‘Šå…§å®¹ ---
    date_str = datetime.now().strftime("%Y-%m-%d")
    
    # åˆ¤æ–·ä¿¡è™Ÿ
    signal_text = "âš–ï¸ **éœ‡ç›ªè§€æœ›**"
    if cur_vix > 30 and mayer < 0.8:
        signal_text = "ğŸš€ **é‘½çŸ³è²·é» (é›™é‡å…±æŒ¯)**\nå»ºè­°ï¼šå¤§è³‡é‡‘åˆ†æ‰¹é€²å ´"
    elif mayer < 0.8:
        signal_text = "ğŸ’ **åƒ¹å€¼ä½ä¼° (Mayer < 0.8)**\nå»ºè­°ï¼šé–‹å•Ÿå®šæŠ•"
    elif cur_vix > 30:
        signal_text = "ğŸ”¥ **å®è§€ææ…Œ (VIX > 30)**\nå»ºè­°ï¼šå·¦å´æ¥åˆ€"
    elif mayer > 2.4:
        signal_text = "ğŸ”´ **é ‚éƒ¨é¢¨éšª (Mayer > 2.4)**\nå»ºè­°ï¼šåˆ†æ‰¹æ­¢ç›ˆ"
    elif fr < -0.01:
        signal_text = "âš¡ **è»‹ç©ºæ©Ÿæœƒ (è²»ç‡è² å€¼)**\nå»ºè­°ï¼šçŸ­ç·šåšå¤š"

    # çµ„åˆè¨Šæ¯ (Markdown æ ¼å¼)
    message = f"""
ğŸ“Š **Phyrex å®è§€æ—¥å ±** ({date_str})
---------------------------
**{signal_text}**
---------------------------
**1. å®è§€ææ…ŒæŒ‡æ¨™**
â€¢ VIX (ææ…Œ): `{cur_vix:.2f}` (è­¦æˆ’: 30)
â€¢ VVIX (æ³¢å‹•): `{cur_vvix:.2f}` (è­¦æˆ’: 110)

**2. æ¯”ç‰¹å¹£åƒ¹å€¼éŒ¨**
â€¢ ç¾åƒ¹: `${cur_btc:,.0f}`
â€¢ ä¼°å€¼ (Mayer): `{mayer:.2f}`
  *(<0.8 æŠ„åº• / >2.4 é€ƒé ‚)*

**3. çŸ­ç·šæƒ…ç·’**
â€¢ è³‡é‡‘è²»ç‡: `{fr:.4f}%`
---------------------------
_Generated by Python Automation_
"""
    
    # ç™¼é€è«‹æ±‚
    url = f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage"
    payload = {
        "chat_id": TG_CHAT_ID,
        "text": message,
        "parse_mode": "Markdown"
    }
    
    try:
        resp = requests.post(url, json=payload)
        if resp.status_code == 200:
            print("âœ… è¨Šæ¯ç™¼é€æˆåŠŸï¼")
        else:
            print(f"âŒ ç™¼é€å¤±æ•—: {resp.text}")
    except Exception as e:
        print(f"âŒ éŒ¯èª¤: {e}")

if __name__ == "__main__":
    analyze_and_send()
