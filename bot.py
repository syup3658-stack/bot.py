import os
import requests
import yfinance as yf
import pandas as pd
import ccxt
import math
from datetime import datetime

# --- è¨­å®šä½ çš„ Telegram åƒæ•¸ ---
# å¦‚æœæ˜¯ GitHub Actions è‡ªå‹•åŒ–ï¼Œæœƒå¾ç’°å¢ƒè®Šæ•¸è®€å–
TG_TOKEN = os.environ.get('TG_TOKEN', "ä½ çš„_TOKEN_æ¸¬è©¦ç”¨") 
TG_CHAT_ID = os.environ.get('TG_CHAT_ID', "ä½ çš„_CHAT_ID_æ¸¬è©¦ç”¨")

def get_data():
    # 1. æŠ“å–å®è§€æ•¸æ“š
    print("æ­£åœ¨æŠ“å–æ•¸æ“š...")
    tickers = ["^VIX", "^VVIX", "BTC-USD"]
    
    # ä¸‹è¼‰æ•¸æ“š
    try:
        data = yf.download(tickers, period="5d", progress=False)
    except Exception as e:
        print(f"ä¸‹è¼‰å¤±æ•—: {e}")
        return None, None, None, 0.0

    # è¼”åŠ©å‡½æ•¸ï¼šå®‰å…¨æå–æ•¸æ“šåºåˆ— (å»é™¤ç©ºå€¼)
    def get_clean_last_val(ticker):
        try:
            # è™•ç† yfinance çš„å¤šå±¤ç´¢å¼•æˆ–å–®å±¤ç´¢å¼•
            if 'Close' in data.columns:
                df = data['Close']
            else:
                df = data

            if isinstance(df, pd.DataFrame) and ticker in df.columns:
                series = df[ticker]
            else:
                # å¦‚æœåªæœ‰ä¸€å€‹ tickerï¼Œå¯èƒ½æ²’æœ‰ ticker æ¬„ä½
                series = df.iloc[:, 0] if ticker == tickers[0] else df

            # é—œéµä¿®å¾©ï¼šç§»é™¤ç©ºå€¼ (NaN)ï¼Œåªå–æœ€å¾Œä¸€ç­†ã€Œæœ‰æ•ˆã€æ•¸å­—
            valid_series = series.dropna()
            
            if valid_series.empty:
                return 0.0
            
            return float(valid_series.iloc[-1])
        except Exception as e:
            print(f"æ•¸æ“šè§£æéŒ¯èª¤ ({ticker}): {e}")
            return 0.0

    # ç²å–æœ€æ–°æœ‰æ•ˆå€¼
    cur_vix = get_clean_last_val("^VIX")
    cur_vvix = get_clean_last_val("^VVIX")
    cur_btc = get_clean_last_val("BTC-USD")
    
    # ç‚ºäº†è¨ˆç®— Mayer Multipleï¼Œæˆ‘å€‘éœ€è¦ BTC çš„æ­·å²åºåˆ—
    try:
        btc_hist = yf.download("BTC-USD", period="1y", progress=False)['Close']
        if isinstance(btc_hist, pd.DataFrame): btc_hist = btc_hist.iloc[:, 0]
        ma200 = float(btc_hist.rolling(window=200).mean().iloc[-1])
    except:
        ma200 = cur_btc # é˜²æ­¢å ±éŒ¯ï¼Œæš«æ™‚è¨­ç‚ºç¾åƒ¹

    # 2. æŠ“å–å¹£å®‰æ•¸æ“š
    binance = ccxt.binance()
    try:
        funding = binance.fapiPublic_get_premiumindex({'symbol': 'BTCUSDT'})
        fr = float(funding['lastFundingRate']) * 100
    except:
        fr = 0.0

    return cur_vix, cur_vvix, cur_btc, ma200, fr

def analyze_and_send():
    cur_vix, cur_vvix, cur_btc, ma200, fr = get_data()
    
    # è¨ˆç®— Mayer Multiple
    mayer = cur_btc / ma200 if ma200 > 0 else 0
    
    # --- ç”Ÿæˆå ±å‘Šå…§å®¹ ---
    date_str = datetime.now().strftime("%Y-%m-%d")
    
    # åˆ¤æ–·ä¿¡è™Ÿ
    signal_text = "âš–ï¸ **éœ‡ç›ªè§€æœ›**"
    if cur_vix > 30 and mayer < 0.8:
        signal_text = "ğŸš€ **é‘½çŸ³è²·é» (é›™é‡å…±æŒ¯)**\nå»ºè­°ï¼šå¤§è³‡é‡‘åˆ†æ‰¹é€²å ´"
    elif mayer > 0 and mayer < 0.8: # ç¢ºä¿ä¸æ˜¯0
        signal_text = "ğŸ’ **åƒ¹å€¼ä½ä¼° (Mayer < 0.8)**\nå»ºè­°ï¼šé–‹å•Ÿå®šæŠ•"
    elif cur_vix > 30:
        signal_text = "ğŸ”¥ **å®è§€ææ…Œ (VIX > 30)**\nå»ºè­°ï¼šå·¦å´æ¥åˆ€"
    elif mayer > 2.4:
        signal_text = "ğŸ”´ **é ‚éƒ¨é¢¨éšª (Mayer > 2.4)**\nå»ºè­°ï¼šåˆ†æ‰¹æ­¢ç›ˆ"
    elif fr < -0.01:
        signal_text = "âš¡ **è»‹ç©ºæ©Ÿæœƒ (è²»ç‡è² å€¼)**\nå»ºè­°ï¼šçŸ­ç·šåšå¤š"

    # çµ„åˆè¨Šæ¯
    message = f"""
ğŸ“Š **å®è§€æ—¥å ±** ({date_str})
---------------------------
**{signal_text}**
---------------------------
**1. å®è§€ææ…ŒæŒ‡æ¨™**
â€¢ VIX (ææ…Œ): `{cur_vix:.2f}` (è­¦æˆ’: 30)
â€¢ VVIX (æ³¢å‹•): `{cur_vvix:.2f}` (è­¦æˆ’: 110)

**2. æ¯”ç‰¹å¹£åƒ¹å€¼éŒ¨**
â€¢ ç¾åƒ¹: `${cur_btc:,.0f}`
â€¢ ä¼°å€¼ (Mayer): `{mayer:.2f}`
  *(<0.8 æŠ„åº• / >2.4 é€ƒé ‚)*

**3. çŸ­ç·šæƒ…ç·’**
â€¢ è³‡é‡‘è²»ç‡: `{fr:.4f}%`
---------------------------
_Generated by GitHub Actions_
"""
    
    # ç™¼é€è«‹æ±‚
    if TG_TOKEN and TG_CHAT_ID:
        url = f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage"
        payload = {
            "chat_id": TG_CHAT_ID,
            "text": message,
            "parse_mode": "Markdown"
        }
        
        try:
            resp = requests.post(url, json=payload)
            if resp.status_code == 200:
                print("âœ… è¨Šæ¯ç™¼é€æˆåŠŸï¼")
            else:
                print(f"âŒ ç™¼é€å¤±æ•—: {resp.text}")
        except Exception as e:
            print(f"âŒ éŒ¯èª¤: {e}")
    else:
        print("âŒ æ‰¾ä¸åˆ° Token æˆ– Chat ID")

if __name__ == "__main__":
    analyze_and_send()
